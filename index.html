import React, { useState, useEffect, useRef } from 'react';
import { Menu, Settings, Trash2, RefreshCw, Upload, Download, Plus, X, Image as ImageIcon, Save, MessageSquare } from 'lucide-react';

// --- 模拟数据结构 ---
const INITIAL_CONTACTS = [
  { id: 1, name: 'AI 助手 1', avatar: 'https://api.dicebear.com/7.x/bottts/svg?seed=1', 
    config: { provider: 'OpenAI', url: 'https://api.openai.com/v1', apiKey: '', model: 'gpt-3.5-turbo' },
    privateMemory: [] 
  }
];

const INITIAL_PUBLIC_MEMORY = [];

export default function AIChatApp() {
  // --- 状态管理 ---
  const [contacts, setContacts] = useState(INITIAL_CONTACTS);
  const [currentContactId, setCurrentContactId] = useState(1);
  const [messages, setMessages] = useState({}); // { contactId: [messages] }
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showMemory, setShowMemory] = useState(false);
  const [themeColor, setThemeColor] = useState('#3b82f6'); // 默认蓝色
  const [wallpaper, setWallpaper] = useState(''); // 背景图 URL
  
  // 获取当前联系人
  const currentContact = contacts.find(c => c.id === currentContactId) || contacts[0];
  const currentMessages = messages[currentContactId] || [];

  // --- 功能函数 ---

  // 1. 发送消息 (模拟)
  const handleSendMessage = (text) => {
    const newMessage = { id: Date.now(), role: 'user', content: text };
    const updatedMessages = [...currentMessages, newMessage];
    
    setMessages({ ...messages, [currentContactId]: updatedMessages });
    
    // 模拟 AI 回复 (实际应调用 API)
    setTimeout(() => {
      const aiMsg = { id: Date.now() + 1, role: 'assistant', content: `这是 ${currentContact.name} 的模拟回复。\n\n使用了模型: ${currentContact.config.model}` };
      setMessages(prev => ({
        ...prev,
        [currentContactId]: [...updatedMessages, aiMsg]
      }));
    }, 1000);
  };

  // 2. 撤回消息 (删除 User 及其后的 AI 消息)
  const handleRecall = (msgIndex) => {
    // 逻辑：删除当前消息，如果是 User 消息，通常删除它以及它后面的 AI 回复
    const newMsgs = currentMessages.slice(0, msgIndex);
    setMessages({ ...messages, [currentContactId]: newMsgs });
  };

  // 3. 重新生成
  const handleRegenerate = () => {
    // 找到最后一条 User 消息，删除其后的 AI 消息并重新触发请求
    const lastUserIndex = currentMessages.findLastIndex(m => m.role === 'user');
    if (lastUserIndex !== -1) {
      const msgsToKeep = currentMessages.slice(0, lastUserIndex + 1);
      setMessages({ ...messages, [currentContactId]: msgsToKeep });
      // 这里重新触发 API 调用逻辑
      setTimeout(() => {
        const aiMsg = { id: Date.now(), role: 'assistant', content: "这是重新生成的回复..." };
        setMessages(prev => ({ ...prev, [currentContactId]: [...msgsToKeep, aiMsg] }));
      }, 1000);
    }
  };

  // 4. 数据导入导出
  const exportData = () => {
    const data = JSON.stringify({ contacts, messages, themeColor, wallpaper });
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ai-chat-backup.json';
    a.click();
  };

  const importData = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if(data.contacts) setContacts(data.contacts);
          if(data.messages) setMessages(data.messages);
          if(data.themeColor) setThemeColor(data.themeColor);
          if(data.wallpaper) setWallpaper(data.wallpaper);
          alert("数据导入成功");
        } catch (err) {
          alert("文件格式错误");
        }
      };
      reader.readAsText(file);
    }
  };

  // --- 界面组件 ---

  return (
    <div 
      className="h-screen w-full flex overflow-hidden text-sm md:text-base relative"
      style={{ '--theme-color': themeColor }}
    >
      {/* 背景层 */}
      <div 
        className="absolute inset-0 z-0 bg-gray-50 dark:bg-gray-900 bg-cover bg-center transition-all"
        style={{ backgroundImage: wallpaper ? `url(${wallpaper})` : 'none' }}
      />
      <div className="absolute inset-0 z-0 bg-white/80 dark:bg-black/50 backdrop-blur-sm" />

      {/* --- 左侧边栏 (联系人列表) --- */}
      <div className={`
        fixed inset-y-0 left-0 z-40 w-64 bg-white/95 shadow-xl transform transition-transform duration-300 ease-in-out
        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}
      `}>
        <div className="p-4 flex justify-between items-center border-b" style={{ borderColor: themeColor }}>
          <h2 className="font-bold text-lg">联系人</h2>
          <button onClick={() => setSidebarOpen(false)}><X size={20} /></button>
        </div>
        
        <div className="p-2 overflow-y-auto h-[calc(100%-120px)]">
          {contacts.map(contact => (
            <div 
              key={contact.id}
              onClick={() => { setCurrentContactId(contact.id); setSidebarOpen(false); }}
              className={`flex items-center p-3 mb-2 rounded-xl cursor-pointer transition-colors ${currentContactId === contact.id ? 'bg-opacity-20' : 'hover:bg-gray-100'}`}
              style={{ backgroundColor: currentContactId === contact.id ? themeColor + '33' : '' }}
            >
              <img src={contact.avatar} className="w-10 h-10 rounded-full mr-3 border border-gray-200" alt="avatar"/>
              <span className="font-medium truncate">{contact.name}</span>
              <button 
                className="ml-auto text-red-400 p-1"
                onClick={(e) => { e.stopPropagation(); setContacts(contacts.filter(c => c.id !== contact.id)); }}
              >
                <Trash2 size={14} />
              </button>
            </div>
          ))}
          <button 
            onClick={() => {
              const newId = Date.now();
              setContacts([...contacts, { 
                id: newId, 
                name: '新 AI', 
                avatar: `https://api.dicebear.com/7.x/bottts/svg?seed=${newId}`, 
                config: { provider: 'OpenAI', url: '', apiKey: '', model: '' },
                privateMemory: []
              }]);
            }}
            className="w-full py-3 mt-2 border-2 border-dashed rounded-xl flex justify-center items-center text-gray-500 hover:text-[var(--theme-color)]"
            style={{ borderColor: themeColor }}
          >
            <Plus size={16} className="mr-2"/> 添加联系人
          </button>
        </div>

        {/* 底部全局设置 */}
        <div className="absolute bottom-0 w-full p-4 border-t bg-gray-50">
          <label className="flex items-center justify-between text-xs text-gray-600 mb-2">
            <span>系统颜色</span>
            <input type="color" value={themeColor} onChange={(e) => setThemeColor(e.target.value)} />
          </label>
          <div className="flex justify-between gap-2">
             <label className="flex-1 text-center py-2 bg-gray-200 rounded cursor-pointer text-xs">
                <Upload size={14} className="inline mr-1"/> 导入
                <input type="file" className="hidden" onChange={importData} accept=".json" />
             </label>
             <button onClick={exportData} className="flex-1 py-2 bg-gray-200 rounded text-xs">
                <Download size={14} className="inline mr-1"/> 导出
             </button>
          </div>
        </div>
      </div>

      {/* --- 主聊天界面 --- */}
      <div className="flex-1 flex flex-col relative z-10 h-full w-full">
        
        {/* 顶部导航栏 */}
        <div className="h-14 px-4 flex items-center justify-between bg-white/90 border-b shadow-sm backdrop-blur">
          <button onClick={() => setSidebarOpen(true)} className="p-2 -ml-2">
            <Menu size={24} style={{ color: themeColor }} />
          </button>
          
          <div className="flex items-center">
            <span className="font-bold">{currentContact.name}</span>
          </div>

          <div className="flex gap-3">
             {/* 记忆库按钮 */}
             <button onClick={() => setShowMemory(true)}>
                <Save size={20} className="text-gray-600" />
             </button>
             {/* 设置按钮 (针对当前联系人) */}
             <button onClick={() => setShowSettings(true)}>
                <Settings size={20} className="text-gray-600" />
             </button>
          </div>
        </div>

        {/* 消息列表 */}
        <div className="flex-1 overflow-y-auto p-4 space-y-6">
          {currentMessages.map((msg, idx) => (
            <div key={msg.id} className={`flex w-full ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
              
              {msg.role === 'assistant' && (
                <div className="flex flex-col w-full max-w-full">
                   {/* AI 消息 - 全屏风格，左侧无气泡，直接显示 */}
                   <div className="flex gap-3">
                      <img src={currentContact.avatar} className="w-8 h-8 rounded-full shrink-0 self-start" alt="ai"/>
                      <div className="flex-1 text-gray-800 leading-relaxed pt-1">
                          {msg.content}
                      </div>
                   </div>
                   {/* AI 底部工具栏 */}
                   <div className="ml-11 mt-2 flex gap-4 text-gray-400 text-xs">
                      <button onClick={handleRegenerate} className="flex items-center hover:text-blue-500"><RefreshCw size={12} className="mr-1"/> 重新生成</button>
                   </div>
                </div>
              )}

              {msg.role === 'user' && (
                <div className="flex flex-col items-end max-w-[85%]">
                  {/* 用户消息 - 气泡风格 */}
                  <div 
                    className="px-4 py-2 rounded-2xl text-white rounded-br-none shadow-sm"
                    style={{ backgroundColor: themeColor }}
                  >
                    {msg.content}
                  </div>
                  {/* 用户 底部工具栏 */}
                  <div className="mt-1 text-gray-400 text-xs">
                      <button onClick={() => handleRecall(idx)} className="hover:text-red-500">撤回</button>
                  </div>
                </div>
              )}
            </div>
          ))}
          {currentMessages.length === 0 && (
             <div className="text-center text-gray-400 mt-20">开始与 {currentContact.name} 对话</div>
          )}
        </div>

        {/* 底部输入框 */}
        <div className="p-3 bg-white/90 border-t backdrop-blur">
          <form 
            onSubmit={(e) => { e.preventDefault(); const text = e.target.msg.value; if(text) { handleSendMessage(text); e.target.msg.value=''; } }}
            className="flex gap-2 items-end"
          >
            <textarea 
              name="msg"
              placeholder="发送消息..." 
              className="flex-1 bg-gray-100 rounded-xl px-4 py-3 max-h-32 focus:outline-none focus:ring-1 resize-none"
              style={{ '--tw-ring-color': themeColor }}
              rows={1}
            />
            <button 
              type="submit" 
              className="p-3 rounded-full text-white shadow-lg transition-transform active:scale-95"
              style={{ backgroundColor: themeColor }}
            >
              <MessageSquare size={20} />
            </button>
          </form>
        </div>

      </div>

      {/* --- 设置模态框 (针对当前联系人) --- */}
      {showSettings && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
          <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div className="p-4 border-b flex justify-between items-center bg-gray-50">
              <h3 className="font-bold">设置 - {currentContact.name}</h3>
              <button onClick={() => setShowSettings(false)}><X size={20}/></button>
            </div>
            <div className="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
              {/* 头像与名称 */}
              <div className="flex items-center gap-4">
                 <img src={currentContact.avatar} className="w-16 h-16 rounded-full border" alt="preview" />
                 <div className="flex-1">
                    <label className="text-xs text-gray-500">名称</label>
                    <input 
                      className="w-full border-b focus:outline-none py-1" 
                      value={currentContact.name}
                      onChange={(e) => {
                         const newContacts = contacts.map(c => c.id === currentContactId ? {...c, name: e.target.value} : c);
                         setContacts(newContacts);
                      }}
                    />
                 </div>
              </div>
              
              {/* API 设置 */}
              <div className="space-y-3">
                 <div>
                    <label className="text-xs font-bold text-gray-500 block">服务商</label>
                    <select 
                      className="w-full p-2 border rounded-lg mt-1 bg-white"
                      value={currentContact.config.provider}
                      onChange={(e) => {
                        const newContacts = contacts.map(c => c.id === currentContactId ? {...c, config: {...c.config, provider: e.target.value}} : c);
                        setContacts(newContacts);
                      }}
                    >
                      <option value="OpenAI">OpenAI</option>
                      <option value="Anthropic">Anthropic</option>
                      <option value="Custom">Custom (Ollama/Local)</option>
                    </select>
                 </div>
                 <div>
                    <label className="text-xs font-bold text-gray-500 block">API Endpoint (URL)</label>
                    <input 
                      className="w-full p-2 border rounded-lg mt-1 text-sm font-mono bg-gray-50"
                      value={currentContact.config.url}
                      placeholder="https://api.openai.com/v1"
                      onChange={(e) => {
                        const newContacts = contacts.map(c => c.id === currentContactId ? {...c, config: {...c.config, url: e.target.value}} : c);
                        setContacts(newContacts);
                      }}
                    />
                 </div>
                 <div>
                    <label className="text-xs font-bold text-gray-500 block">API Key</label>
                    <input 
                      type="password"
                      className="w-full p-2 border rounded-lg mt-1 text-sm font-mono bg-gray-50"
                      value={currentContact.config.apiKey}
                      placeholder="sk-..."
                      onChange={(e) => {
                        const newContacts = contacts.map(c => c.id === currentContactId ? {...c, config: {...c.config, apiKey: e.target.value}} : c);
                        setContacts(newContacts);
                      }}
                    />
                 </div>
                 <div className="flex gap-2 items-end">
                    <div className="flex-1">
                       <label className="text-xs font-bold text-gray-500 block">模型</label>
                       <input 
                          className="w-full p-2 border rounded-lg mt-1 text-sm"
                          value={currentContact.config.model}
                          onChange={(e) => {
                            const newContacts = contacts.map(c => c.id === currentContactId ? {...c, config: {...c.config, model: e.target.value}} : c);
                            setContacts(newContacts);
                          }}
                        />
                    </div>
                    <button className="px-3 py-2 bg-gray-200 rounded-lg text-xs font-bold h-10 hover:bg-gray-300 whitespace-nowrap">
                       拉取列表
                    </button>
                 </div>
              </div>

              {/* 壁纸设置 */}
              <div>
                  <label className="text-xs font-bold text-gray-500 block">自定义壁纸 (URL)</label>
                  <input 
                    className="w-full p-2 border rounded-lg mt-1 text-sm"
                    value={wallpaper}
                    placeholder="https://..."
                    onChange={(e) => setWallpaper(e.target.value)}
                  />
              </div>
            </div>
          </div>
        </div>
      )}

      {/* --- 记忆库模态框 --- */}
      {showMemory && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
           <div className="bg-white w-full max-w-lg rounded-2xl shadow-xl h-[80vh] flex flex-col">
              <div className="p-4 border-b flex justify-between items-center">
                 <h3 className="font-bold">记忆库管理</h3>
                 <button onClick={() => setShowMemory(false)}><X size={20}/></button>
              </div>
              <div className="p-2 bg-gray-100 flex gap-2">
                 <div className="flex-1 text-center py-2 bg-white rounded shadow-sm text-sm font-bold border-b-2" style={{borderColor: themeColor}}>公共记忆</div>
                 <div className="flex-1 text-center py-2 text-gray-500 text-sm">专属记忆 ({currentContact.name})</div>
              </div>
              <div className="flex-1 overflow-y-auto p-4">
                 {/* 列表形式展示记忆 */}
                 <div className="space-y-2">
                    <div className="p-3 bg-blue-50 border border-blue-100 rounded-lg flex justify-between items-start">
                       <p className="text-sm text-gray-700">用户喜欢使用 Python 进行编程。</p>
                       <button className="text-gray-400 hover:text-red-500"><Trash2 size={14}/></button>
                    </div>
                    {/* 模拟空状态 */}
                    <button className="w-full py-3 border-2 border-dashed rounded-lg text-gray-400 text-sm flex items-center justify-center gap-2 hover:bg-gray-50">
                       <Plus size={16}/> 添加新记忆条目
                    </button>
                 </div>
              </div>
           </div>
        </div>
      )}

    </div>
  );
}
