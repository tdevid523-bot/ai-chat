<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Chat Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 移动端优化 */
        body, html { height: 100%; overflow: hidden; background-color: #f3f4f6; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .message-bubble { max-width: 85%; word-wrap: break-word; white-space: pre-wrap; }
        /* 弹窗过渡动画 */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s; }
        .slide-enter-from, .slide-leave-to { transform: translateX(-100%); }
    </style>
</head>
<body>

<div id="app" class="h-full flex flex-col relative">

    <header class="bg-white shadow-sm h-14 flex items-center justify-between px-4 z-20 shrink-0">
        <button @click="showSidebar = true" class="text-gray-600 p-2">
            <i class="fas fa-bars fa-lg"></i>
        </button>

        <h1 class="font-bold text-lg truncate max-w-[150px]">{{ currentContact ? currentContact.name : '未选择联系人' }}</h1>

        <button @click="openSettings" class="text-gray-600 p-2" :disabled="!currentContact">
            <i class="fas fa-cog fa-lg"></i>
        </button>
    </header>

    <div v-if="showSidebar" class="absolute inset-0 z-40 flex">
        <div class="bg-gray-800 w-3/4 h-full shadow-2xl flex flex-col p-4 text-white" @click.stop>
            <div class="flex justify-between items-center mb-6 border-b border-gray-600 pb-2">
                <h2 class="text-xl font-bold">联系人</h2>
                <button @click="addContact" class="text-green-400"><i class="fas fa-plus"></i> 新增</button>
            </div>
            
            <div class="flex-1 overflow-y-auto space-y-2">
                <div v-for="(contact, index) in contacts" :key="contact.id" 
                     @click="selectContact(index)"
                     class="p-3 rounded cursor-pointer flex justify-between items-center"
                     :class="currentIndex === index ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'">
                    <span>{{ contact.name }}</span>
                    <button @click.stop="deleteContact(index)" class="text-red-400 p-1"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
        </div>
        <div class="flex-1 bg-black bg-opacity-50" @click="showSidebar = false"></div>
    </div>

    <main class="flex-1 overflow-y-auto p-4 space-y-4 pb-20 scrollbar-hide bg-gray-100" id="chat-container">
        <div v-if="!currentContact" class="text-center text-gray-400 mt-20">
            请点击左上角选择或添加联系人
        </div>
        
        <template v-else>
            <div v-for="(msg, index) in currentContact.messages" :key="index" class="flex flex-col gap-1">
                <div :class="['flex', msg.role === 'user' ? 'justify-end' : 'justify-start']">
                    <div :class="['message-bubble p-3 rounded-lg shadow text-sm', 
                        msg.role === 'user' ? 'bg-green-500 text-white rounded-br-none' : 'bg-white text-gray-800 rounded-bl-none']">
                        {{ msg.content }}
                    </div>
                </div>
                
                <div v-if="index === currentContact.messages.length - 1" class="flex justify-end gap-2 text-xs text-gray-400 px-1">
                    <button v-if="msg.role === 'assistant'" @click="regenerate" class="hover:text-blue-500">
                        <i class="fas fa-redo"></i> 重成
                    </button>
                    <button @click="revokeMessage" class="hover:text-red-500">
                        <i class="fas fa-undo"></i> 撤回
                    </button>
                </div>
            </div>
            
            <div v-if="isLoading" class="flex justify-start">
                <div class="bg-gray-200 p-3 rounded-lg text-gray-500 text-sm animate-pulse">
                    正在思考...
                </div>
            </div>
        </template>
    </main>

    <footer class="bg-white border-t p-3 flex gap-2 items-end shrink-0 z-10 safe-area-bottom">
        <textarea v-model="inputMessage" rows="1" class="flex-1 bg-gray-100 rounded-lg p-2 max-h-32 focus:outline-none focus:ring-1 focus:ring-blue-500 resize-none" placeholder="输入消息..."></textarea>
        <button @click="sendMessage" :disabled="isLoading || !currentContact" class="bg-blue-600 text-white rounded-lg px-4 py-2 disabled:bg-gray-400">
            <i class="fas fa-paper-plane"></i>
        </button>
    </footer>

    <div v-if="showSettings" class="absolute inset-0 z-50 bg-white flex flex-col animate-fade-in">
        <div class="flex justify-between items-center p-4 border-b bg-gray-50">
            <h2 class="text-lg font-bold">设置: {{ currentContact.name }}</h2>
            <button @click="closeSettings" class="text-gray-600"><i class="fas fa-times fa-lg"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <div class="space-y-3">
                <label class="block text-sm font-bold text-gray-700">联系人名称</label>
                <input v-model="currentContact.name" class="w-full border rounded p-2" type="text">
            </div>

            <div class="space-y-3 border-t pt-4">
                <h3 class="font-bold text-gray-800">API 配置 (当前联系人独享)</h3>
                
                <div>
                    <label class="text-xs text-gray-500">服务商/Base URL</label>
                    <input v-model="currentContact.config.baseUrl" placeholder="https://api.openai.com/v1" class="w-full border rounded p-2 text-sm">
                </div>
                
                <div>
                    <label class="text-xs text-gray-500">API Key</label>
                    <input v-model="currentContact.config.apiKey" type="password" placeholder="sk-..." class="w-full border rounded p-2 text-sm">
                </div>

                <div class="flex gap-2 items-end">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500">模型 (Model)</label>
                        <select v-model="currentContact.config.model" class="w-full border rounded p-2 bg-white text-sm">
                            <option v-for="m in modelList" :value="m">{{ m }}</option>
                            <option :value="currentContact.config.model">{{ currentContact.config.model }} (当前)</option>
                        </select>
                    </div>
                    <button @click="fetchModels" class="bg-gray-200 text-gray-700 px-3 py-2 rounded text-sm whitespace-nowrap">
                        <i class="fas fa-sync"></i> 拉取
                    </button>
                </div>
            </div>

            <div class="space-y-3 border-t pt-4">
                <div class="flex justify-between items-center">
                    <h3 class="font-bold text-gray-800">记忆库</h3>
                    <div class="flex bg-gray-200 rounded p-1 text-xs">
                        <button @click="memoryTab = 'private'" :class="['px-3 py-1 rounded', memoryTab === 'private' ? 'bg-white shadow' : 'text-gray-500']">专属</button>
                        <button @click="memoryTab = 'public'" :class="['px-3 py-1 rounded', memoryTab === 'public' ? 'bg-white shadow' : 'text-gray-500']">公共</button>
                    </div>
                </div>

                <div class="text-xs text-gray-500 mb-2">
                    {{ memoryTab === 'private' ? '仅当前联系人生效' : '所有联系人共用' }}
                </div>

                <ul class="space-y-2">
                    <li v-for="(mem, idx) in currentMemoryList" :key="idx" class="bg-yellow-50 border border-yellow-200 p-2 rounded flex justify-between items-start gap-2">
                        <span v-if="editingMemoryIndex !== idx" class="text-sm text-gray-800 break-all">{{ mem }}</span>
                        <input v-else v-model="editingMemoryText" class="flex-1 border-b border-blue-500 outline-none bg-transparent text-sm">
                        
                        <div class="flex gap-2 shrink-0 pt-0.5">
                            <button v-if="editingMemoryIndex !== idx" @click="startEditMemory(idx, mem)" class="text-blue-400"><i class="fas fa-pen"></i></button>
                            <button v-if="editingMemoryIndex === idx" @click="saveEditMemory(idx)" class="text-green-500"><i class="fas fa-check"></i></button>
                            <button @click="deleteMemory(idx)" class="text-red-400"><i class="fas fa-times"></i></button>
                        </div>
                    </li>
                </ul>

                <div class="flex gap-2 mt-2">
                    <input v-model="newMemoryInput" placeholder="添加一条新记忆..." class="flex-1 border rounded p-2 text-sm">
                    <button @click="addMemory" class="bg-blue-500 text-white px-3 rounded"><i class="fas fa-plus"></i></button>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;

    createApp({
        setup() {
            // --- 状态数据 ---
            const showSidebar = ref(false);
            const showSettings = ref(false);
            const isLoading = ref(false);
            const inputMessage = ref('');
            const currentIndex = ref(-1);
            
            // 记忆库Tab状态
            const memoryTab = ref('private'); // 'private' or 'public'
            const newMemoryInput = ref('');
            const editingMemoryIndex = ref(-1);
            const editingMemoryText = ref('');
            
            const modelList = ref(['gpt-3.5-turbo', 'gpt-4o', 'gpt-4o-mini', 'gemini-1.5-flash']); // 默认列表
            
            // 公共记忆
            const publicMemories = ref([]); 

            // 联系人结构
            const contacts = ref([
                {
                    id: Date.now(),
                    name: "默认助手",
                    config: {
                        baseUrl: "https://api.openai.com/v1",
                        apiKey: "",
                        model: "gpt-3.5-turbo"
                    },
                    privateMemories: [],
                    messages: [
                        { role: 'assistant', content: '你好！我是你的AI助手。请在右上角设置我的API Key。' }
                    ]
                }
            ]);

            // --- 计算属性 ---
            const currentContact = computed(() => {
                if (currentIndex.value === -1 || !contacts.value.length) return null;
                return contacts.value[currentIndex.value];
            });

            // 当前显示的记忆列表（根据Tab切换）
            const currentMemoryList = computed(() => {
                if (memoryTab.value === 'public') return publicMemories.value;
                if (currentContact.value) return currentContact.value.privateMemories;
                return [];
            });

            // --- 方法 ---

            // 1. 数据持久化 (LocalStorage)
            const saveData = () => {
                localStorage.setItem('ai_chat_contacts', JSON.stringify(contacts.value));
                localStorage.setItem('ai_chat_public_mem', JSON.stringify(publicMemories.value));
            };

            const loadData = () => {
                const savedContacts = localStorage.getItem('ai_chat_contacts');
                const savedPublic = localStorage.getItem('ai_chat_public_mem');
                if (savedContacts) contacts.value = JSON.parse(savedContacts);
                if (savedPublic) publicMemories.value = JSON.parse(savedPublic);
                if (contacts.value.length > 0) currentIndex.value = 0;
            };

            onMounted(() => {
                loadData();
            });

            watch([contacts, publicMemories], saveData, { deep: true });

            // 2. 联系人管理
            const addContact = () => {
                contacts.value.push({
                    id: Date.now(),
                    name: "新联系人",
                    config: { baseUrl: "", apiKey: "", model: "gpt-3.5-turbo" },
                    privateMemories: [],
                    messages: []
                });
                currentIndex.value = contacts.value.length - 1;
                showSidebar.value = false;
                showSettings.value = true; // 自动打开设置
            };

            const deleteContact = (index) => {
                if (confirm('确定删除该联系人及其所有记录吗？')) {
                    contacts.value.splice(index, 1);
                    if (contacts.value.length === 0) currentIndex.value = -1;
                    else currentIndex.value = 0;
                }
            };

            const selectContact = (index) => {
                currentIndex.value = index;
                showSidebar.value = false;
            };

            // 3. 记忆库管理
            const addMemory = () => {
                if (!newMemoryInput.value.trim()) return;
                if (memoryTab.value === 'public') {
                    publicMemories.value.push(newMemoryInput.value.trim());
                } else {
                    currentContact.value.privateMemories.push(newMemoryInput.value.trim());
                }
                newMemoryInput.value = '';
            };

            const deleteMemory = (idx) => {
                if (memoryTab.value === 'public') publicMemories.value.splice(idx, 1);
                else currentContact.value.privateMemories.splice(idx, 1);
            };

            const startEditMemory = (idx, text) => {
                editingMemoryIndex.value = idx;
                editingMemoryText.value = text;
            };

            const saveEditMemory = (idx) => {
                if (editingMemoryText.value.trim()) {
                    if (memoryTab.value === 'public') publicMemories.value[idx] = editingMemoryText.value.trim();
                    else currentContact.value.privateMemories[idx] = editingMemoryText.value.trim();
                }
                editingMemoryIndex.value = -1;
            };

            // 4. API 交互与消息处理
            const scrollToBottom = () => {
                nextTick(() => {
                    const el = document.getElementById('chat-container');
                    if(el) el.scrollTop = el.scrollHeight;
                });
            };

            const fetchModels = async () => {
                const config = currentContact.value.config;
                if (!config.apiKey || !config.baseUrl) {
                    alert('请先填写 Base URL 和 API Key');
                    return;
                }
                try {
                    // 尝试从 baseUrl/models 获取
                    let url = config.baseUrl;
                    if (!url.endsWith('/')) url += '/';
                    // 处理 endpoint，有些是 v1/models 有些直接 models
                    const targetUrl = url.includes('v1') ? url + 'models' : url + 'v1/models';
                    
                    const res = await fetch(targetUrl, {
                        headers: { 'Authorization': `Bearer ${config.apiKey}` }
                    });
                    const data = await res.json();
                    if (data.data) {
                        modelList.value = data.data.map(m => m.id);
                        alert(`成功获取 ${modelList.value.length} 个模型`);
                    } else {
                        throw new Error('格式无法解析');
                    }
                } catch (e) {
                    alert('获取失败，请手动输入模型名称或检查 URL/Key');
                    console.error(e);
                }
            };

            const sendMessage = async () => {
                if (!inputMessage.value.trim() || isLoading.value) return;
                
                const userMsg = inputMessage.value.trim();
                currentContact.value.messages.push({ role: 'user', content: userMsg });
                inputMessage.value = '';
                scrollToBottom();

                await callLLM();
            };

            const callLLM = async () => {
                isLoading.value = true;
                const contact = currentContact.value;
                
                // 构建 System Prompt (公共记忆 + 私有记忆)
                const systemPrompt = [
                    "Public Memories:\n" + publicMemories.value.join('\n'),
                    "Private Memories:\n" + contact.privateMemories.join('\n'),
                    "Instruction: You are a helpful assistant. Utilize the memories provided above contextually."
                ].join('\n\n');

                const messagesPayload = [
                    { role: 'system', content: systemPrompt },
                    ...contact.messages
                ];

                try {
                    let url = contact.config.baseUrl;
                    if (!url.endsWith('/')) url += '/';
                    const targetUrl = url.includes('/chat/completions') ? url : url + 'chat/completions';

                    const res = await fetch(targetUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${contact.config.apiKey}`
                        },
                        body: JSON.stringify({
                            model: contact.config.model,
                            messages: messagesPayload,
                            stream: false // 简化版暂不使用流式，为了手机端更稳定
                        })
                    });

                    const data = await res.json();
                    if (data.error) throw new Error(data.error.message);
                    
                    const aiContent = data.choices[0].message.content;
                    contact.messages.push({ role: 'assistant', content: aiContent });
                    scrollToBottom();
                } catch (e) {
                    contact.messages.push({ role: 'assistant', content: `[错误]: ${e.message}` });
                } finally {
                    isLoading.value = false;
                }
            };

            // 撤回功能
            const revokeMessage = () => {
                const msgs = currentContact.value.messages;
                if (msgs.length === 0) return;
                
                // 如果最后一条是AI发的，我们需要删除 AI消息 + 用户的上一条消息
                const lastMsg = msgs[msgs.length - 1];
                if (lastMsg.role === 'assistant') {
                    // 删除最后两条
                    msgs.pop(); // AI
                    if (msgs.length > 0 && msgs[msgs.length - 1].role === 'user') {
                        // 把用户发的消息回填到输入框，方便修改
                        inputMessage.value = msgs[msgs.length - 1].content; 
                        msgs.pop(); // User
                    }
                } else {
                    // 如果最后一条是User发的（比如卡住没发出去，或者刚发想撤回），只删这一条
                    inputMessage.value = lastMsg.content;
                    msgs.pop();
                }
            };

            // 重新生成
            const regenerate = () => {
                const msgs = currentContact.value.messages;
                if (msgs.length === 0) return;

                // 如果最后一条是AI，删掉它，然后重新调用callLLM
                if (msgs[msgs.length - 1].role === 'assistant') {
                    msgs.pop();
                    callLLM();
                }
            };

            const openSettings = () => showSettings.value = true;
            const closeSettings = () => showSettings.value = false;

            return {
                showSidebar, showSettings, isLoading, inputMessage,
                contacts, currentIndex, currentContact,
                memoryTab, newMemoryInput, currentMemoryList, publicMemories,
                modelList,
                addContact, deleteContact, selectContact,
                addMemory, deleteMemory, startEditMemory, saveEditMemory, editingMemoryIndex, editingMemoryText,
                openSettings, closeSettings,
                sendMessage, revokeMessage, regenerate, fetchModels
            };
        }
    }).mount('#app');
</script>
</body>
</html>
