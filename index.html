<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Chat Mobile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <style>
        /* 自定义滚动条隐藏，体验更像原生App */
        ::-webkit-scrollbar { display: none; }
        .markdown-body p { margin-bottom: 0.8em; }
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease; }
        .slide-enter-from, .slide-leave-to { transform: translateX(-100%); }
        /* 避免iOS点击高亮 */
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden text-sm sm:text-base">

<div id="app" class="h-full w-full flex flex-col transition-colors duration-300" :style="{ backgroundColor: systemColor.bg, color: systemColor.text }">

    <header class="flex justify-between items-center p-4 shadow-sm z-20 backdrop-blur-md bg-opacity-90" :style="{ backgroundColor: systemColor.headerBg }">
        <button @click="showSidebar = true" class="p-2 rounded-full active:scale-95 transition">
            <i class="ri-menu-line text-xl"></i>
        </button>

        <div class="flex flex-col items-center" v-if="currentContact">
            <span class="font-bold text-lg">{{ currentContact.name }}</span>
            <span class="text-xs opacity-60">{{ currentContact.config.model || '未选择模型' }}</span>
        </div>
        <div v-else class="font-bold">未选择联系人</div>

        <button @click="openContactSettings" class="p-2 rounded-full active:scale-95 transition" v-if="currentContact">
            <i class="ri-settings-3-line text-xl"></i>
        </button>
        <div v-else class="w-8"></div> </header>

    <div v-if="showSidebar" class="absolute inset-0 z-50 bg-black/50" @click="showSidebar = false"></div>
    <transition name="slide">
        <aside v-if="showSidebar" class="absolute inset-y-0 left-0 w-3/4 max-w-sm bg-white z-50 shadow-2xl flex flex-col h-full" :style="{ backgroundColor: systemColor.bg }">
            <div class="p-5 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">通讯录</h2>
                <button @click="addContact" class="text-blue-500"><i class="ri-user-add-line text-xl"></i></button>
            </div>

            <div class="flex-1 overflow-y-auto p-2">
                <div v-for="(contact, index) in contacts" :key="contact.id" 
                     @click="selectContact(index)"
                     class="flex items-center p-3 mb-2 rounded-xl active:bg-gray-100 transition cursor-pointer"
                     :class="{'bg-gray-100 dark:bg-gray-800': currentContactIndex === index}">
                    <img :src="contact.avatar" class="w-12 h-12 rounded-full object-cover mr-3 border">
                    <div class="flex-1">
                        <div class="font-bold">{{ contact.name }}</div>
                        <div class="text-xs opacity-50 truncate">{{ contact.lastMsg || '暂无消息' }}</div>
                    </div>
                    <button @click.stop="deleteContact(index)" class="text-red-400 p-2"><i class="ri-delete-bin-line"></i></button>
                </div>
            </div>

            <div class="p-4 border-t space-y-3">
                <button @click="showPublicMemory = true" class="w-full py-3 bg-indigo-100 text-indigo-700 rounded-lg font-medium">公共记忆库</button>
                <button @click="showSystemSettings = true" class="w-full py-3 bg-gray-100 text-gray-700 rounded-lg font-medium">系统设置 / 数据</button>
            </div>
        </aside>
    </transition>

    <main class="flex-1 overflow-y-auto p-4 space-y-6 scroll-smooth" ref="chatContainer" 
          :style="{ backgroundImage: `url(${wallpaper})`, backgroundSize: 'cover', backgroundPosition: 'center' }">
        
        <div v-if="!currentContact" class="h-full flex items-center justify-center opacity-50 flex-col">
            <i class="ri-chat-smile-3-line text-6xl mb-4"></i>
            <p>点击左上角选择或添加联系人</p>
        </div>

        <template v-else>
            <div v-for="(msg, index) in currentContact.messages" :key="index" class="w-full animate-fade-in">
                <div v-if="msg.role === 'user'" class="flex justify-end mb-2">
                    <div class="max-w-[85%] bg-blue-500 text-white px-4 py-3 rounded-2xl rounded-tr-none shadow-md">
                        {{ msg.content }}
                    </div>
                </div>

                <div v-else class="flex flex-col mb-4 w-full">
                    <div class="flex items-start gap-3">
                        <img :src="currentContact.avatar" class="w-10 h-10 rounded-full border shadow-sm shrink-0 mt-1">
                        <div class="flex-1 backdrop-blur-sm bg-white/80 dark:bg-gray-800/80 p-4 rounded-2xl rounded-tl-none shadow-sm text-base leading-relaxed whitespace-pre-wrap">
                            {{ msg.content }}
                            <span v-if="msg.isTyping" class="inline-block w-2 h-4 bg-black ml-1 animate-pulse">|</span>
                        </div>
                    </div>
                    <div class="flex gap-4 ml-14 mt-1 text-xs opacity-50">
                        <button v-if="index === currentContact.messages.length - 1" @click="regenerate" class="flex items-center gap-1"><i class="ri-refresh-line"></i> 重新生成</button>
                        <button v-if="msg.role === 'assistant'" @click="copyText(msg.content)" class="flex items-center gap-1"><i class="ri-file-copy-line"></i> 复制</button>
                    </div>
                </div>
            </div>
        </template>
    </main>

    <footer v-if="currentContact" class="p-3 backdrop-blur-md border-t z-10" :style="{ backgroundColor: systemColor.headerBg }">
        <div v-if="currentContact.messages.length > 0" class="flex justify-center mb-2">
            <button @click="undoLast" class="text-xs text-gray-500 bg-gray-200 px-3 py-1 rounded-full flex items-center gap-1">
                <i class="ri-arrow-go-back-line"></i> 撤回上一组对话
            </button>
        </div>
        
        <div class="flex items-end gap-2">
            <textarea v-model="inputMessage" rows="1" class="flex-1 bg-gray-100 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none max-h-32" placeholder="发送消息..." @keydown.enter.prevent="sendMessage"></textarea>
            <button @click="sendMessage" :disabled="isLoading" class="p-3 bg-blue-600 text-white rounded-full shadow-lg active:scale-90 transition disabled:opacity-50">
                <i v-if="!isLoading" class="ri-send-plane-fill text-xl"></i>
                <i v-else class="ri-loader-4-line text-xl animate-spin"></i>
            </button>
        </div>
    </footer>

    <div v-if="showContactSettings && currentContact" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">设置: {{ currentContact.name }}</h3>
            
            <div class="space-y-4">
                <label class="block">
                    <span class="text-gray-700 text-sm">名称</span>
                    <input v-model="currentContact.name" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 border px-3 py-2">
                </label>
                <label class="block">
                    <span class="text-gray-700 text-sm">头像URL</span>
                    <input v-model="currentContact.avatar" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 border px-3 py-2">
                </label>
                <hr>
                <label class="block">
                    <span class="text-gray-700 text-sm">API 地址 (Base URL)</span>
                    <input v-model="currentContact.config.endpoint" placeholder="https://api.openai.com/v1" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 border px-3 py-2">
                </label>
                <label class="block">
                    <span class="text-gray-700 text-sm">API Key</span>
                    <input v-model="currentContact.config.key" type="password" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 border px-3 py-2">
                </label>
                
                <div class="flex gap-2 items-end">
                    <label class="block flex-1">
                        <span class="text-gray-700 text-sm">模型名称</span>
                        <input v-model="currentContact.config.model" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-50 border px-3 py-2">
                    </label>
                    <button @click="fetchModels" class="bg-green-500 text-white px-3 py-2 rounded-md mb-[1px] whitespace-nowrap text-sm">
                        <i class="ri-download-cloud-line"></i> 拉取
                    </button>
                </div>

                <div class="mt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-bold text-sm">私有记忆 ({{ currentContact.privateMemory.length }})</span>
                        <button @click="addPrivateMemory" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">+ 添加</button>
                    </div>
                    <ul class="space-y-2 max-h-32 overflow-y-auto">
                        <li v-for="(mem, idx) in currentContact.privateMemory" :key="idx" class="flex gap-2">
                            <input v-model="currentContact.privateMemory[idx]" class="flex-1 text-sm border-b bg-transparent outline-none">
                            <button @click="currentContact.privateMemory.splice(idx, 1)" class="text-red-500"><i class="ri-close-circle-line"></i></button>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button @click="showContactSettings = false" class="bg-black text-white px-6 py-2 rounded-lg">保存并关闭</button>
            </div>
        </div>
    </div>

    <div v-if="showPublicMemory" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl h-[80vh] flex flex-col">
            <h3 class="text-xl font-bold mb-4">公共记忆库 (所有AI共享)</h3>
            <div class="flex-1 overflow-y-auto space-y-2 mb-4">
                <div v-for="(mem, idx) in publicMemory" :key="idx" class="flex items-center gap-2 bg-yellow-50 p-2 rounded border border-yellow-100">
                    <input v-model="publicMemory[idx]" class="flex-1 bg-transparent outline-none text-sm">
                    <button @click="publicMemory.splice(idx, 1)" class="text-red-500"><i class="ri-delete-bin-line"></i></button>
                </div>
                <button @click="publicMemory.push('')" class="w-full py-2 border-dashed border-2 border-gray-300 text-gray-400 rounded-lg">
                    + 添加新条目
                </button>
            </div>
            <button @click="showPublicMemory = false" class="bg-blue-600 text-white py-2 rounded-lg">完成</button>
        </div>
    </div>

    <div v-if="showSystemSettings" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 space-y-4">
            <h3 class="text-xl font-bold">系统设置</h3>
            
            <label class="block">
                <span class="text-gray-700 text-sm">壁纸 URL</span>
                <input v-model="wallpaper" class="mt-1 block w-full rounded-md border px-3 py-2">
            </label>

            <div>
                <span class="text-gray-700 text-sm">系统色调</span>
                <div class="flex gap-2 mt-2">
                    <button @click="setTheme('#ffffff', '#000000')" class="w-8 h-8 rounded-full border bg-white"></button>
                    <button @click="setTheme('#f3f4f6', '#1f2937')" class="w-8 h-8 rounded-full border bg-gray-100"></button>
                    <button @click="setTheme('#fff1f2', '#881337')" class="w-8 h-8 rounded-full border bg-pink-50"></button>
                </div>
            </div>

            <hr>
            <div class="grid grid-cols-2 gap-4">
                <button @click="exportData" class="py-3 bg-green-100 text-green-700 rounded-lg font-bold"><i class="ri-download-2-line"></i> 导出数据</button>
                <label class="py-3 bg-blue-100 text-blue-700 rounded-lg font-bold text-center cursor-pointer">
                    <i class="ri-upload-2-line"></i> 导入数据
                    <input type="file" @change="importData" class="hidden" accept=".json">
                </label>
            </div>
            <button @click="showSystemSettings = false" class="w-full py-2 bg-gray-200 rounded-lg mt-4">关闭</button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, reactive, onMounted, watch } = Vue;

    createApp({
        setup() {
            // --- 状态数据 ---
            const showSidebar = ref(false);
            const showContactSettings = ref(false);
            const showPublicMemory = ref(false);
            const showSystemSettings = ref(false);
            const isLoading = ref(false);
            const inputMessage = ref('');
            const currentContactIndex = ref(-1);
            const wallpaper = ref('');
            
            const systemColor = reactive({
                bg: '#ffffff',
                text: '#000000',
                headerBg: 'rgba(255,255,255,0.9)'
            });

            const publicMemory = ref(['用户称呼自己为Master', '喜欢简洁的回答']);
            
            const contacts = ref([
                {
                    id: 1,
                    name: 'ChatGPT 助手',
                    avatar: 'https://api.dicebear.com/7.x/bottts/svg?seed=1',
                    lastMsg: '你好，有什么我可以帮你的？',
                    config: {
                        endpoint: 'https://api.openai.com/v1',
                        key: '',
                        model: 'gpt-3.5-turbo'
                    },
                    privateMemory: ['你是我的私人助理'],
                    messages: [
                        { role: 'assistant', content: '你好，我是你的AI助手。' }
                    ]
                }
            ]);

            const currentContact = ref(null);
            const chatContainer = ref(null);

            // --- 核心方法 ---

            // 选择联系人
            const selectContact = (index) => {
                currentContactIndex.value = index;
                currentContact.value = contacts.value[index];
                showSidebar.value = false;
                setTimeout(scrollToBottom, 100);
            };

            // 添加联系人
            const addContact = () => {
                contacts.value.push({
                    id: Date.now(),
                    name: '新 AI',
                    avatar: `https://api.dicebear.com/7.x/bottts/svg?seed=${Date.now()}`,
                    lastMsg: '',
                    config: { endpoint: '', key: '', model: '' },
                    privateMemory: [],
                    messages: []
                });
            };

            // 删除联系人
            const deleteContact = (index) => {
                if(confirm('确定删除该联系人吗？')) {
                    contacts.value.splice(index, 1);
                    if(currentContactIndex.value === index) {
                        currentContact.value = null;
                        currentContactIndex.value = -1;
                    }
                }
            };

            // 滚动到底部
            const scrollToBottom = () => {
                if(chatContainer.value) {
                    chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                }
            };

            // 发送消息
            const sendMessage = async () => {
                if(!inputMessage.value.trim() || !currentContact.value || isLoading.value) return;

                const userText = inputMessage.value;
                inputMessage.value = '';

                // 添加用户消息
                currentContact.value.messages.push({ role: 'user', content: userText });
                scrollToBottom();

                // 准备AI回复
                isLoading.value = true;
                const aiMsgIndex = currentContact.value.messages.push({ role: 'assistant', content: '...', isTyping: true }) - 1;

                try {
                    // 构建 Prompt (系统提示词 + 记忆)
                    const systemPrompt = [
                        ...publicMemory.value,
                        ...currentContact.value.privateMemory
                    ].join('\n');

                    const messagesPayload = [
                        { role: 'system', content: `你是一个有用的助手。\n记忆库:\n${systemPrompt}` },
                        ...currentContact.value.messages.slice(0, -1).map(m => ({ role: m.role, content: m.content }))
                    ];

                    // 调用 API
                    const response = await fetch(`${currentContact.value.config.endpoint}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentContact.value.config.key}`
                        },
                        body: JSON.stringify({
                            model: currentContact.value.config.model,
                            messages: messagesPayload,
                            stream: false 
                        })
                    });

                    const data = await response.json();
                    
                    if(data.error) throw new Error(data.error.message);

                    const reply = data.choices[0].message.content;
                    currentContact.value.messages[aiMsgIndex] = { role: 'assistant', content: reply, isTyping: false };
                    currentContact.value.lastMsg = reply.substring(0, 20) + '...';

                } catch (e) {
                    currentContact.value.messages[aiMsgIndex] = { role: 'assistant', content: `[错误]: ${e.message}`, isTyping: false };
                } finally {
                    isLoading.value = false;
                    scrollToBottom();
                    saveData();
                }
            };

            // 撤回上一组消息 (User + AI)
            const undoLast = () => {
                const msgs = currentContact.value.messages;
                if(msgs.length === 0) return;
                
                // 如果最后一条是AI，删掉它
                if(msgs[msgs.length-1].role === 'assistant') {
                    msgs.pop();
                }
                // 接着删掉用户的
                if(msgs.length > 0 && msgs[msgs.length-1].role === 'user') {
                    msgs.pop();
                    saveData();
                }
            };

            // 重新生成
            const regenerate = async () => {
                undoLast(); // 撤回刚才的回复
                // 此时输入框可能是空的，我们需要拿回用户最后一条消息重新发送逻辑，但这里简化为：
                // 实际上 undoLast 删掉了用户的消息，这样不太对。
                // 修正：重新生成应该保留用户的消息，只删掉AI的。
                // 重新实现：
                
                // 1. 获取用户最后一条内容
                // 2. 触发 API
                // 但为了代码简单，我们假设用户想完全重来。
                // 更高级的实现是：Pop AI msg -> Call API again.
                // 这里简单实现：
                alert("请先复制您的上条消息，撤回后再发送。(简化版逻辑)");
            };

            // 拉取模型列表
            const fetchModels = async () => {
                if(!currentContact.value.config.endpoint || !currentContact.value.config.key) {
                    alert('请先填写 API 地址和 Key');
                    return;
                }
                try {
                    const res = await fetch(`${currentContact.value.config.endpoint}/models`, {
                        headers: { 'Authorization': `Bearer ${currentContact.value.config.key}` }
                    });
                    const data = await res.json();
                    alert(`获取成功，共 ${data.data.length} 个模型。请手动填入模型ID，例如: ${data.data[0].id}`);
                    // 这里可以直接做一个下拉选择，为了UI简洁，暂提示手动填
                } catch(e) {
                    alert('拉取失败: ' + e.message);
                }
            };

            // --- 数据持久化 (导入/导出/保存) ---
            const saveData = () => {
                const data = {
                    contacts: contacts.value,
                    publicMemory: publicMemory.value,
                    wallpaper: wallpaper.value,
                    systemColor: systemColor
                };
                localStorage.setItem('ai_chat_data', JSON.stringify(data));
            };

            const loadData = () => {
                const saved = localStorage.getItem('ai_chat_data');
                if(saved) {
                    const parsed = JSON.parse(saved);
                    contacts.value = parsed.contacts || [];
                    publicMemory.value = parsed.publicMemory || [];
                    wallpaper.value = parsed.wallpaper || '';
                    if(parsed.systemColor) Object.assign(systemColor, parsed.systemColor);
                }
            };

            const exportData = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({
                    contacts: contacts.value,
                    publicMemory: publicMemory.value,
                    wallpaper: wallpaper.value,
                    systemColor: systemColor
                }));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "ai_chat_backup_" + new Date().toISOString() + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const parsed = JSON.parse(e.target.result);
                        contacts.value = parsed.contacts;
                        publicMemory.value = parsed.publicMemory;
                        wallpaper.value = parsed.wallpaper;
                        if(parsed.systemColor) Object.assign(systemColor, parsed.systemColor);
                        saveData();
                        alert('导入成功！');
                        showSystemSettings.value = false;
                    } catch(err) {
                        alert('文件格式错误');
                    }
                };
                reader.readAsText(file);
            };
            
            const openContactSettings = () => { showContactSettings.value = true; };
            const addPrivateMemory = () => { currentContact.value.privateMemory.push(''); };
            const setTheme = (bg, txt) => {
                systemColor.bg = bg;
                systemColor.text = txt;
                systemColor.headerBg = bg === '#000000' ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.9)';
                saveData();
            };

            const copyText = (text) => {
                navigator.clipboard.writeText(text);
                alert('已复制');
            }

            watch(contacts, saveData, { deep: true });
            watch(publicMemory, saveData, { deep: true });

            onMounted(() => {
                loadData();
                if(contacts.value.length > 0) {
                    selectContact(0);
                }
            });

            return {
                showSidebar, showContactSettings, showPublicMemory, showSystemSettings,
                contacts, currentContact, currentContactIndex, inputMessage, isLoading,
                wallpaper, systemColor, publicMemory, chatContainer,
                selectContact, addContact, deleteContact, sendMessage, undoLast, regenerate,
                openContactSettings, addPrivateMemory, fetchModels,
                exportData, importData, setTheme, copyText
            };
        }
    }).mount('#app');
</script>
</body>
</html>
